---
title: "Tarea 1"
author: "Carlos Crespín"
date: "2024-04-04"
output: 
  html_document:
    toc: true
    toc_float: true
    collapsed: false
    number_sections: false
    toc_depth: 1
    code_download: true
    theme: flatly
    highlight: textmate
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

<img src="https://imgur.com/T5KQ7qg.jpg" width="400"/>

<center>

<h1>Analítica Social e Inteligencia Estratégica</h1>

</center>

<br>



# Pregunta 1
```{r}
library(rio)
data=import("datos_abiertos_vigilancia_dengue.csv")
```

```{r}
summary(data$edad)
```
```{r}
str(data)
```
```{r}
library(dplyr)
```

```{r}
table(data$enfermedad)
```


```{r}
data$enfermedad <- gsub("DENGUE CON SEÑALES DE ALARMA", "con", data$enfermedad)
data$enfermedad <- gsub("DENGUE SIN SEÑALES DE ALARMA", "sin", data$enfermedad)
data$enfermedad <- gsub("DENGUE GRAVE", "grave", data$enfermedad)
```


```{r}
table(data$enfermedad)
```
```{r}
data=filter(data, enfermedad=="con" | enfermedad=="sin" | enfermedad=="grave")
data$enfermedad=as.factor(data$enfermedad)
```

```{r}
table(data$enfermedad)
```

```{r}
summary(data$edad)
```

# Pregunta 2
```{r}
library(lsr)
EdadxYear = data |>
  group_by(year) |>
  summarise(media = mean(edad, na.rm=T))
EdadxYear
```

## Gráfico

```{r}
library(ggplot2)
library(ggthemes)

# Crear el gráfico de líneas
library(ggplot2)

ggplot(EdadxYear, aes(x = year, y = media)) +
  geom_line(color = "blue", size = 1.5) +
  geom_point(color = "red", size = 3) +  
  labs(title = "Edad promedio de personas contagiadas de dengue por año",
       x = "Año",
       y = "Edad") +
  theme_economist() +
  theme(legend.key.size = unit(1, "lines"),  # Tamaño de la leyenda
        plot.title = element_text(size = 10))  # Tamaño del título

```



# Pregunta 3

```{r}
pregunta2 <- data %>%
  group_by(year) %>%
  summarise(
    total_casos = n(),
    graves = sum(enfermedad == "grave"),
    sin_señales = sum(enfermedad == "sin"),
    con_señales = sum(enfermedad == "con")
  ) 
```


## Grafico

```{r}
library(ggplot2)

# Suponiendo que tus datos están en un dataframe llamado "datos" con las columnas "año", "total", "con_alarma", "sin_alarma" y "graves"

# Crear gráficos de líneas individuales para cada variable
grafico_total <- ggplot(pregunta2, aes(x = year, y = total_casos)) +
  geom_line() +
  labs(title = "Total de casos de Dengue a lo largo de los años",
       x = "Año",
       y = "Total de casos") +
  theme_minimal()

grafico_con_alarma <- ggplot(pregunta2, aes(x = year, y = con_señales)) +
  geom_line() +
  labs(title = "Casos de Dengue con Alarma a lo largo de los años",
       x = "Año",
       y = "Casos con Alarma") +
  theme_minimal()

grafico_sin_alarma <- ggplot(pregunta2, aes(x = year, y = sin_señales)) +
  geom_line() +
  labs(title = "Casos de Dengue sin Alarma a lo largo de los años",
       x = "Año",
       y = "Casos sin Alarma") +
  theme_minimal()

grafico_graves <- ggplot(pregunta2, aes(x = year, y = graves)) +
  geom_line() +
  labs(title = "Casos de Dengue Graves a lo largo de los años",
       x = "Año",
       y = "Casos Graves") +
  theme_minimal()

# Mostrar los gráficos por separado
print(grafico_total)
print(grafico_con_alarma)
print(grafico_sin_alarma)
print(grafico_graves)

```


# Pregunta 4

```{r}

pregunta4 <- data %>%
  group_by(departamento, provincia, year) %>%
  summarize(
    con_alarma = sum(enfermedad == "con"),
    sin_alarma = sum(enfermedad == "sin"),
    graves = sum(enfermedad == "graves")
  )

# Mostrar los primeros registros de la base de datos resumida
head(pregunta4)
```

Ahora añadiré el total
```{r}
pregunta4 <- pregunta4 %>%
  mutate(total_contagios = con_alarma + sin_alarma + graves)
head(pregunta4)
```

Data nueva completa ahora sí todo

```{r}
provyear <- pregunta4 %>%
  group_by(departamento, provincia) %>%
  summarise(total_historico = sum(total_contagios))
```

```{r}
summary(provyear$total_historico)
```

Puesto que la media es 1138, los datos que estén por encima de dicha media serán
consideradas muy altas

```{r}
provyear=filter(provyear, total_historico>4499.2)
```

## Gráfico de puntos
```{r}
library(ggplot2)

# Crear el gráfico de puntos
grafico <- ggplot(provyear, aes(x = departamento, y = total_historico, label = provincia)) +
  geom_point(color = "red", size = 3) +  # Puntos azules
  geom_text(size = 1.9, vjust = -0.5) +  # Etiquetas con un tamaño y alineación vertical adecuados
  labs(title = "Provincias con mayor número de casos de dengue",  # Título del gráfico
       x = "Departamentos", y = "Total de casos") +  # Etiquetas de los ejes
  theme_solarized() +  # Estilo minimalista
  theme(plot.title = element_text(hjust = 0.5),  # Alinear título al centro
        plot.margin = unit(c(0.5, 0.5, 0.5, 0.5), "cm"),  # Márgenes del gráfico
        axis.text.x = element_text(size = 4.5),  # Tamaño del texto del eje X
        axis.text.y = element_text(size = 5),  # Tamaño del texto del eje Y
        axis.title.x = element_text(size = 10),  # Tamaño del texto de la etiqueta del eje X
        axis.title.y = element_text(size = 10))  # Tamaño del texto de la etiqueta del eje Y

# Mostrar el gráfico
print(grafico)

```

# Pregunta 5

Ahora bien, para analizar la relación primero haremos una suma de cada dato por 
departamento y después realizaremos un mapa de calor (primera vez que hago uno)

Vamos a explorar primero
```{r}
table(data$departamento)
```
Según lo registra la base de datos, solo se tiene información de 22 departamentos
y NN

Procederemos a limpiar para después crear
```{r}
pregunta5 <- data %>% filter_all(all_vars(. != "\\N"))
table(pregunta5$departamento)
```

Creacion de la data
```{r}
pregunta5 <- pregunta5 %>%
  group_by(departamento) %>%
  summarise(
    total_casos = n(),
    graves = sum(enfermedad == "grave"),
    sin_señales = sum(enfermedad == "sin"),
    con_señales = sum(enfermedad == "con")
  ) 
head(pregunta5)
```

La pregunta me pide analizar la relación entre casos alarmantes no graves y los
asintomaticos. En ese sentido, en la base de datos significa que es la relación 
entre los "con" entre los "sin"

```{r}
pregunta5 <- pregunta5 %>%
  mutate(relacion = con_señales/sin_señales)
pregunta5=select(pregunta5, c(1,6))
head(pregunta5)
```


## Intentaremos importar la data de los mapas
```{r}
library(ggplot2)
library(rgdal)
library(sp)
library(ggplot2)
mapDIS=sf::read_sf("DEPARTAMENTO.shp")
ggplot(mapDIS) + geom_sf()
```
Exploremos un poco más a fondo esta base de datos del mapa
```{r}
names(mapDIS)
#cambiaremos el nombre
names(mapDIS)=c("departamento","capital","institucion","geometry")
```

Toca unir la data para intentar que salga
```{r}
mapa=merge(mapDIS, pregunta5)
```


```{r}
ggplot(mapa) +
    geom_sf(aes(fill = relacion))
```
```{r}
library(ggplot2)

# Crear el gráfico de mapa de calor
grafico <- ggplot(mapa) +
  geom_sf(aes(fill = relacion)) +
  scale_fill_gradient(low = "white", high = "darkred")  # Invertir la escala de colores

# Mostrar el gráfico
print(grafico)

```



```{r}
# Transformar los datos espaciales a otro sistema de coordenadas (3857)
  nc_3857 <- sf::st_transform(mapa, 3857)
  
  # Crear un gráfico con dos capas de datos, una con los datos originales y otra con los datos transformados, coloreando los polígonos en rojo y mostrando los bordes en blanco
  ggplot() +
    geom_sf(data = mapa) +
    geom_sf(data = nc_3857, colour = "red", fill = NA)
  
  # Agregar un punto central a cada polígono y ajustar el tamaño del punto según la variable 'departamento', mostrando el punto en la leyenda
  nc_3857$mid <- sf::st_centroid(nc_3857$geometry)
  ggplot(nc_3857) +
    geom_sf(colour = "white") +
    geom_sf(aes(geometry = mid, size = relacion), show.legend = "point")
  
  # Crear un gráfico con capas que utilizan las coordenadas x e y, estableciendo el sistema de coordenadas predeterminado
  ggplot(nc_3857) +
    geom_sf() +
    annotate("point", x = -80, y = 35, colour = "red", size = 4) +
    coord_sf(default_crs = sf::st_crs(4326))
  
  # Agregar etiquetas a los polígonos
  ggplot(nc_3857[1:3, ]) +
    geom_sf(aes(fill = relacion)) +
    geom_sf_label(aes(label = departamento))

```






































































